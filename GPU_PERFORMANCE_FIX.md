# Оптимизация производительности GPU

## Проблема
GPU используется только на 14% вместо 80-100% во время генерации.

## Причина
**Sequential CPU offload** загружает компоненты модели **по одному**, поэтому:
- GPU работает только во время обработки текущего компонента
- Между компонентами GPU простаивает (ожидает загрузки следующего)
- Это экономит память, но **замедляет работу**

## Решение

### Вариант 1: Обычный CPU Offload (рекомендуется)

Измените в `config.yaml`:
```yaml
device:
  enable_cpu_offload: true
  sequential_offload: false  # Обычный offload - быстрее!
```

**Плюсы:**
- ✅ GPU используется на 80-100% во время генерации
- ✅ Быстрее в 2-3 раза
- ✅ Несколько компонентов на GPU одновременно

**Минусы:**
- ⚠️ Требует больше VRAM (может быть ошибка памяти)
- ⚠️ Если не поместится - вернитесь к sequential

### Вариант 2: Оставить Sequential (если обычный не работает)

Если с обычным offload появляется ошибка памяти:
```yaml
device:
  enable_cpu_offload: true
  sequential_offload: true  # Sequential - медленнее, но экономит память
```

## Что изменилось

Добавлен параметр `sequential_offload` в `config.yaml`:
- `false` - обычный CPU offload (быстрее, больше VRAM)
- `true` - sequential CPU offload (медленнее, меньше VRAM)

## Рекомендация

1. **Попробуйте сначала обычный offload** (`sequential_offload: false`)
2. Если работает без ошибок памяти - используйте его
3. Если появляется "out of memory" - вернитесь к sequential

## Проверка производительности

После изменения конфигурации:

1. Перезапустите приложение
2. Откройте `nvidia-smi -l 1` в отдельном окне
3. Запустите генерацию
4. Следите за **GPU-Util**:
   - Обычный offload: 80-100% постоянно
   - Sequential: 50-100% с простоями

## Текущая конфигурация

По умолчанию установлено `sequential_offload: false` для максимальной скорости.

**Измените config.yaml и перезапустите приложение!**

