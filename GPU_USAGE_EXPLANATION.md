# Почему GPU используется мало?

## Текущая ситуация

Вы видите, что GPU используется только на 1%, хотя модель загружена на CUDA. Это **нормально** при использовании **CPU offload**.

## Как работает CPU Offload

CPU offload переносит часть модели в оперативную память (RAM) и загружает компоненты на GPU только когда они нужны для вычислений. Это позволяет:

✅ **Экономить VRAM** - модель помещается в 8GB  
✅ **Избежать ошибок "out of memory"**  
⚠️ **GPU используется меньше** - компоненты загружаются по очереди, а не все сразу

## Почему GPU показывает 1%?

1. **Модель частично в RAM** - большая часть весов хранится в оперативной памяти
2. **Загрузка по требованию** - компоненты загружаются на GPU только во время вычислений
3. **Диспетчер задач не видит полную загрузку** - он показывает среднее использование, а не пиковое

## Решения

### Вариант 1: Отключить CPU Offload (максимальная скорость)

Если у вас достаточно VRAM, можно отключить CPU offload:

1. Скопируйте конфигурацию:
   ```bash
   copy config_no_offload.yaml config.yaml
   ```

2. Перезапустите приложение:
   ```bash
   python app.py
   ```

**Плюсы:**
- ✅ GPU будет использоваться на 80-100%
- ✅ Генерация будет быстрее (5-10 секунд вместо 15-30)
- ✅ Все компоненты модели на GPU

**Минусы:**
- ⚠️ Требует больше VRAM (~7-8GB)
- ⚠️ Может быть ошибка "out of memory" если не хватит места

### Вариант 2: Оставить CPU Offload (стабильность)

Текущая конфигурация оптимальна для 8GB VRAM:

**Плюсы:**
- ✅ Стабильная работа без ошибок памяти
- ✅ Модель точно поместится
- ✅ Можно использовать другие приложения одновременно

**Минусы:**
- ⚠️ GPU используется меньше (но это нормально!)
- ⚠️ Генерация немного медленнее

## Проверка реального использования GPU

GPU действительно работает, просто диспетчер задач не всегда это показывает правильно. Проверьте:

1. **Во время генерации** - GPU должен показывать 50-100%
2. **Использование VRAM** - должно быть 6-7GB
3. **Скорость генерации** - должна быть быстрее чем на CPU

## Рекомендация

Для **RTX 4060 с 8GB VRAM**:

1. **Попробуйте сначала БЕЗ CPU offload** (config_no_offload.yaml)
   - Если работает без ошибок - используйте этот вариант
   - GPU будет использоваться на 100%, генерация быстрее

2. **Если появляются ошибки памяти** - вернитесь к CPU offload
   - Медленнее, но стабильнее

## Мониторинг GPU

Используйте `nvidia-smi` для точного мониторинга:

```bash
nvidia-smi -l 1  # Обновление каждую секунду
```

Во время генерации вы увидите:
- **GPU-Util**: 80-100%
- **Memory-Usage**: 6-7GB / 8GB
- **Power Usage**: увеличится

